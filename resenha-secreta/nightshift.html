<html>
    <head>
        <meta charset='utf-8'>
        <meta name='viewport' content='width-device-width, initial-scale=1'>
        <title>Turnomacabro</title>
        <style>
            body { margin: 0; overflow: hidden; background-color: black; }
            .office-layer { z-index: 1; }
            .animatronic-layer { z-index: 2; }
            .cam-layer { z-index: 3; }
            .static-layer { z-index: 4; }
            .map-layer { z-index: 5; }
            .door-indicator { z-index: 90; }
            .ui-layer { z-index: 100; }
            .clickable { cursor: pointer; } 

            #nightScreen {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: black;
                color: white;
                display: flex; 
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-family: 'Consolas', 'Courier New', monospace;
                font-size: 400%; 
                text-shadow: 0 0 10px #000000;
                text-align: center;
                z-index: 1000; 
            }
            #nightText {
                margin: 5px 0;
                line-height: 1.2;
            }
            #loadingText {
                font-size: 25%;
                margin-top: 50px;
                color: #555555;
            }

            #musicBoxUI {
                position: absolute;
                top: 76%;
                left: 60%;
                transform: translate(-50%, -50%);
                visibility: hidden; 
                z-index: 102;
                width: 250px; 
                height: 50px; 
                background-color: rgba(0, 0, 0, 0.7);
                border: 2px solid white;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-family: 'Courier New', Courier, monospace;
                color: white;
                text-align: center;
            }
            #musicBoxText {
                font-size: 100%; 
                font-weight: bold;
                padding-bottom: 2px; 
                visibility: visible;
                direction: ltr;
            }
            #musicBoxArea {
                position: relative;
                width: 70%; 
                height: 30px; 
                border: 2px solid white;
                background-color: #333;
                cursor: pointer;
                overflow: hidden;
            }
            #musicBoxBar {
                height: 100%;
                background-color: #3f453f; 
                width: 100%; 
                transition: background-color 0.5s;
            }
            #musicBoxIndicator {
                position: static;
                width: 30%; 
                height: 100%;
                display: flex;
                align-items: center; 
                justify-content: flex-start;
                font-weight: bold;
                color: #aaaaaa; 
                text-shadow: none; 
            }
            
            #dangerOverlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: none; 
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 101; 
                pointer-events: none; 
            }
            #dangerText {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-family: 'Consolas', 'Courier New', monospace; 
                font-size: 300%; 
                font-weight: 900; 
                color: #ff0000; 
                text-shadow: 0 0 1px #000000, 0 0 20px #ff0000; 
                animation: blinker 0.3s linear infinite; 
                letter-spacing: 5px; 
                direction: ltr;
                white-space: nowrap;
            }

            @keyframes blinker {
                50% { opacity: 0; }
            }
            
            .ui-layer-text {
                font-family: "Courier New", Courier, monospace; 
                font-weight: bold; 
                font-size: 200%; 
                color: white; 
                position: absolute;
            }
            #timerTxt { top: 5%; left: 3%; }
            #powerTxt { top: 80%; left: 3%; }
            #usageTxt { top: 87%; left: 3%; }

            #warningOverlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: transparent; 
                display: block; 
                z-index: 200; 
                pointer-events: none; 
                visibility: hidden;
            }
            #warningText {
                position: absolute; 
                top: 20%; 
                left: 45%; 
                transform: translate(-50%, -50%); 
                width: 100%; 
                
                font-family: 'Consolas', 'Courier New', monospace; 
                font-size: 180%; 
                font-weight: 900; 
                color: #667dff; 
                text-shadow: 0 0 5px #000000, 0 0 20px #000000; 
                text-align: center;
                line-height: 0.5;
                white-space: pre-wrap; 
            }

        </style>
    </head>
    <body>
        <div id="nightScreen">
            <p id="nightText">12:00 AM</p>
            <p id="nightText">6th Night</p>
            <p id="loadingText" style="font-size: 25%; margin-top: 50px; color: #555555; visibility: hidden;">STARTING NIGHT SHIFT...</p>
        </div>
        
        <div id='warningOverlay'>
            <p id="warningText">
                BЄWÅRЄ ØF ßUᗪᗪY!
                <br>
                нє нιdєѕ. 
                <br>
                Tøuch Hís Bøx Tø Keep Him Håppy. 
                <br>
                ᗪO NØT Bє His LUNCH!
                <br>
                <span style="font-size: 50%; display: block; margin-top: 10px; color: #FFD700;">
                    بُدّي يَخْتَبِئُ عُلْبَةُ مَوسِيقِيَّةِ
                </span>
            </p>
        </div>
        <img src='nightshift/office-open.png' id='office' class="office-layer" width='100%' height='100%' style='position: absolute; top: 0%; left: 0%;'>
        <img src='nightshift/goldenFreddy/office.png' id='goldenOffice' class="animatronic-layer" width='30%' height='60%' style='position: absolute; top: 40%; left: 35%; visibility: hidden;'>
        <img src='nightshift/kitchen.png' id='camera' class="cam-layer" width='100%' height='100%' style='position: absolute; top: 0%; left: 0%; visibility: hidden;'>
        <img src='nightshift/static.gif' id='static' class="static-layer" width='100%' height='100%' style='position: absolute; top: 0%; left: 0%; visibility: hidden; opacity: 0.3;'>
        
        <img src='nightshift/monitor.png' id='monitor' onclick='handleMonitorClick()' class="ui-layer clickable" width='44%' height='8%' style='position: absolute; top: 87%; left: 27%;'>
        <img src='nightshift/map.png' id='map' class="map-layer ui-layer" width='30%' height='70%' style='position: absolute; top: 20%; left: 70%; visibility: hidden;'>
        
        <img src='nightshift/leftOff.png' id='leftButtom' onclick='leftDoorToggle()' class="ui-layer clickable" width='5%' height='20%' style='position: absolute; top: 40%; left: 0.1%;'>
        <img src='nightshift/doorOpen.png' id='leftDoor' class="door-indicator" width='1.5%' height='3.5%' style='position: absolute; top: 77.3%; left: 80.7%; visibility: hidden;'>
        
        <img src='nightshift/rightOff.png' id='rightButtom' onclick='rightDoorToggle()' class="ui-layer clickable" width='5%' height='20%' style='position: absolute; top: 40%; right: 1%;'>
        <img src='nightshift/doorOpen.png' id='rightDoor' class="door-indicator" width='1.5%' height='3.5%' style='position: absolute; top: 77.3%; left: 84.6%; visibility: hidden;'>
        
        <img src='nightshift/camOff.png' id='showStage' onclick='camera(0)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 25%; left: 78%; visibility: hidden;'>
        <img src='nightshift/camOff.png' id='diningArea' onclick='camera(1)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 33%; left: 76%; visibility: hidden;'>
        <img src='nightshift/camOff.png' id='backstage' onclick='camera(2)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 40%; left: 69%; visibility: hidden;'>
        <img src='nightshift/camOff.png' id='pirateCove' onclick='camera(3)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 47%; left: 74%; visibility: hidden;'>
        <img src='nightshift/camOff.png' id='restrooms' onclick='camera(4)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 38%; left: 94%; visibility: hidden;'>
        <img src='nightshift/camOff.png' id='kitchen' onclick='camera(5)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 61%; left: 94%; visibility: hidden;'>
        <img src='nightshift/camOff.png' id='westHall' onclick='camera(6)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 68%; left: 78%; visibility: hidden;'>
        <img src='nightshift/camOff.png' id='supplyCloset' onclick='camera(7)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 64%; left: 72%; visibility: hidden;'>
        <img src='nightshift/camOff.png' id='westCorner' onclick='camera(8)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 73%; left: 78%; visibility: hidden;'>
        <img src='nightshift/camOff.png' id='eastHall' onclick='camera(9)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 68%; left: 86%; visibility: hidden;'>
        <img src='nightshift/camOff.png' id='eastCorner' onclick='camera(10)' class="cam-button ui-layer clickable" width='4%' height='5%' style='position: absolute; top: 73%; left: 86%; visibility: hidden;'>
        
        <p id='timerTxt' class="ui-layer ui-layer-text">12:00 AM</p>
        <p id='powerTxt' class="ui-layer ui-layer-text">POWER LEFT: 100%</p>
        <p id='usageTxt' class="ui-layer ui-layer-text">USAGE: |</p>
        
        <div id='musicBoxUI'>
            <div id='musicBoxText'></div>
            <div style="display: flex; align-items: center; justify-content: space-between; width: 90%; height: 100%;">
                
                <div id='musicBoxArea' onmousedown="windUpMusicBox(true)" onmouseup="windUpMusicBox(false)" ontouchstart="windUpMusicBox(true)" ontouchend="windUpMusicBox(false)">
                    <div id='musicBoxBar'></div>
                </div>
                
                <div id='musicBoxIndicator'>WIND UP مع السلامة</div>
            </div>
        </div>
        
        <div id='dangerOverlay' class="ui-layer" style='display: none;'>
            <p id="dangerText">UH! س OH! . ANGEREDح THE THING!!</p>
        </div>
        
        <audio src='nightshift/audios/blip3.wav' id='blip'></audio>
        <audio src='nightshift/audios/CMPTR_Low_Tech_Stat.wav' id='ambienceCamera' loop></audio>
        <audio src='nightshift/audios/Laugh_Giggle_Girl_1.wav' id='goldenLaugh'></audio>
        <audio src='nightshift/audios/Laugh_Giggle_Girl_1d.wav' id='laugh1'></audio>
        <audio src='nightshift/audios/Laugh_Giggle_Girl_2d.wav' id='laugh2'></audio>
        <audio src='nightshift/audios/Laugh_Giggle_Girl_8d.wav' id='laugh3'></audio>
        
        <audio src='nightshift/audios/music box.wav' id='musicBox1'></audio>
        <audio src='nightshift/audios/musicbox2.mp3' id='musicBox2'></audio>
        <audio src='nightshift/audios/musicbox3.mp3' id='musicBox3' volume='1.0'></audio> 

        <audio src='nightshift/audios/oui.mp3' id='oui'></audio>
        <audio src='nightshift/audios/OVEN-DRA_1_GEN-HDF18119.wav' id='kitchen1'></audio>
        <audio src='nightshift/audios/OVEN-DRA_2_GEN-HDF18120.wav' id='kitchen2'></audio>
        <audio src='nightshift/audios/powerdown.wav' id='powerDown'></audio>
        <audio src='nightshift/audios/run.wav' id='run'></audio>
        <audio src='nightshift/audios/SFXBible_12478.wav' id='door'></audio>
        <audio src='nightshift/audios/STEREO_CASSETTE__90097701.wav' id='tabletOn'></audio>
        <audio src='nightshift/audios/STEREO_CASSETTE__90097704.wav' id='tabletOff'></audio>
        <audio src='nightshift/audios/walk1.wav' id='walk1'></audio>
        <audio src='nightshift/audios/walk2.wav' id='walk2'></audio>
        <audio src='nightshift/audios/walk3.wav' id='walk3'></audio>
        <audio src='nightshift/audios/walk4.wav' id='walk4'></audio>
        <audio src='nightshift/audios/walk5.wav' id='walk5'></audio>
        <audio src='nightshift/audios/XSCREAM.wav' id='jumpscare'></audio>
        <audio src='nightshift/audios/XSCREAM2.wav' id='goldenJumpscare'></audio>
        <audio src='nightshift/audios/creepy_loop.wav' id='creepyMusic' loop></audio>
        
        <audio src='nightshift/audios/windup.ogg' id='windupEffect'></audio>
        <audio src='nightshift/audios/special.oga' id='specialJumpscare'></audio>

        <audio src='nightshift/audios/uhoh.mp3' id='dangerWarning'></audio>
        
        <audio id="audio" src="03. Pizza Dinner.mp3" loop></audio>
        
        <script>
            let leftDoor = false;
            let rightDoor = false;
            let tablet = false;
            let timerCounter = 12;
            let powerCounter = 100;
            let usageCounter = 1; 
            
            let bunny = -1;
            let chicken = -1;
            let bear = -1;
            let bearOutage = 0; 
            let fox = 0; 
            let goldenRandom = 0;
            let goldenScare = 0;
            let currentCam = 0;
            
            let musicBoxTime = 100; 
            let musicBoxDrainRate = 0.3; 
            let musicBoxGraceTime = 0; 
            let isWinding = false;
            let musicBoxJumpscareInProgress = false;
            let musicBoxFinished = false; 

            let activeMusicBoxID = 'musicBox1'; 
            
            let windupInterval = null; 
            
            let audioContextUnlocked = false; 

            function safeGetElement(id) {
                const el = document.getElementById(id);
                if (!el) {
                    console.error(`CRITICAL ERROR: Element with ID '${id}' not found!`);
                }
                return el;
            }

            function safePlay(id, resetTime = true) {
                const el = safeGetElement(id);
                if (el && typeof el.play === 'function') {
                    if (resetTime) {
                        el.currentTime = 0; 
                    }
                    el.play().catch(e => {
                        if (e.name === 'NotAllowedError') { 
                             console.warn(`[ÁUDIO] Não foi possível reproduzir ${id} automaticamente. Contexto de áudio bloqueado.`);
                        } else if (e.name === 'NotFoundError') {
                             console.error(`[ÁUDIO] ERRO: O arquivo de áudio para ID '${id}' não foi encontrado. Verifique o caminho.`);
                        } else if (e.name !== 'AbortError') { 
                            console.warn(`[ÁUDIO] Erro ao reproduzir ${id}:`, e);
                        }
                    });
                }
            }

            function safePause(id) {
                const el = safeGetElement(id);
                if (el && typeof el.pause === 'function') {
                    el.pause();
                }
            }
            
            function stopAllMusicBoxTracks() {
                safePause('musicBox1');
                safePause('musicBox2');
                safePause('musicBox3');
            }

            function playActiveMusicBoxTrack() {
                if (activeMusicBoxID) {
                    safePlay(activeMusicBoxID, false); 
                }
            }
            
            function selectNextMusicBoxTrack() {
                const weightedTracks = [
                    { id: 'musicBox1', weight: 0 }, 
                    { id: 'musicBox2', weight: 40 }, 
                    { id: 'musicBox3', weight: 40 }
                ];
                
                const totalWeight = weightedTracks.reduce((sum, track) => sum + track.weight, 0);
                let random = Math.random() * totalWeight;

                if (totalWeight === 0) {
                     activeMusicBoxID = Math.random() < 0.5 ? 'musicBox2' : 'musicBox3';
                     return;
                }

                for (const track of weightedTracks) {
                    if (random < track.weight) {
                        activeMusicBoxID = track.id;
                        return;
                    }
                    random -= track.weight;
                }
                
                activeMusicBoxID = 'musicBox2'; 
            }

            function setupMusicBoxListeners() {
                const trackIDs = ['musicBox1', 'musicBox2', 'musicBox3'];
                trackIDs.forEach(id => {
                    const track = safeGetElement(id);
                    if (track) {
                        track.loop = false; 
                        track.onended = () => {
                            if (tablet && currentCam === 5 && musicBoxTime > 0) {
                                stopAllMusicBoxTracks(); 
                                selectNextMusicBoxTrack();
                                playActiveMusicBoxTrack();
                            }
                        };
                    }
                });
            }

            function gameOverCleanUp() {
                const uiElements = ['leftButtom', 'rightButtom', 'monitor', 'timerTxt', 'powerTxt', 'usageTxt', 'goldenOffice', 'camera', 'static', 'map', 'leftDoor', 'rightDoor', 'musicBoxUI', 'dangerOverlay', 'warningOverlay', 'nightScreen']; 
                uiElements.forEach(id => {
                    const el = safeGetElement(id);
                    if (el) el.style.visibility = 'hidden';
                });

                const camButtons = ['showStage', 'diningArea', 'backstage', 'pirateCove', 'restrooms', 'kitchen', 'westHall', 'supplyCloset', 'westCorner', 'eastHall', 'eastCorner'];
                camButtons.forEach(id => {
                    const el = safeGetElement(id);
                    if (el) el.style.visibility = 'hidden';
                });
                
                tablet = false;
                
                const ambience = safeGetElement('ambienceCamera');
                if (ambience) ambience.pause();
                stopAllMusicBoxTracks(); 
                const creepyMusic = safeGetElement('creepyMusic');
                if (creepyMusic) creepyMusic.pause();
                
                if (windupInterval) {
                    clearInterval(windupInterval);
                    windupInterval = null;
                }
                
                const audio = safeGetElement('audio');
                if (audio) audio.pause();
            }

            function updateOfficeImage() {
                const officeImg = safeGetElement('office');
                if (!officeImg) return; 

                let imgPath = 'nightshift/';

                if (leftDoor && rightDoor) {
                    imgPath += 'office-closed.png'; 
                } else if (leftDoor && !rightDoor) {
                    imgPath += 'office-left-door.png'; 
                } else if (!leftDoor && rightDoor) {
                    imgPath += 'office-right-door.png'; 
                } else { 
                    imgPath += 'office-open.png';
                }

                officeImg.src = imgPath;
            }

            function usage(){
                const usageTxt = safeGetElement('usageTxt');
                if (!usageTxt) return;

                let usageBars = '|';
                if (usageCounter === 2) usageBars = '||';
                else if (usageCounter === 3) usageBars = '|||';
                else if (usageCounter >= 4) usageBars = '||||';

                usageTxt.innerText = `USAGE: ${usageBars}`;
            }
            
            function updateMusicBoxUI() {
                const bar = safeGetElement('musicBoxBar');
                const indicator = safeGetElement('musicBoxIndicator');
                const musicBoxText = safeGetElement('musicBoxText');

                if (!bar || !indicator || !musicBoxText) return;

                const percent = Math.max(0, musicBoxTime);
                bar.style.width = percent + '%';
                
                const inDangerGrace = musicBoxGraceTime > 0;
                
                if (percent > 50) {
                    bar.style.backgroundColor = '#999999'; 
                } else if (percent > 20) {
                    bar.style.backgroundColor = '#666666'; 
                } else {
                    bar.style.backgroundColor = '#ff0000'; 
                }

                if (inDangerGrace) {
                    musicBoxText.style.visibility = 'hidden'; 
                    indicator.innerText = ''; 
                    safeGetElement('musicBoxArea').style.borderColor = 'red';
                    safeGetElement('musicBoxArea').style.backgroundColor = 'darkred';
                } else {
                    musicBoxText.style.visibility = 'visible'; 
                    safeGetElement('musicBoxArea').style.borderColor = 'white';
                    safeGetElement('musicBoxArea').style.backgroundColor = '#333';

                    if (percent <= 0) {
                        indicator.innerText = 'EMPTY! DANGER!';
                    } else {
                        indicator.innerText = 'WIND UP مع السلامة';
                    }
                }
            }

            function tickMusicBox() {
                if (musicBoxJumpscareInProgress || powerCounter <= 0 || bearOutage === 1) return;
                
                if (musicBoxGraceTime > 0) {
                    musicBoxGraceTime = Math.max(0, musicBoxGraceTime - 0.05); 
                    
                    if (musicBoxGraceTime <= 0) {
                        stopAllMusicBoxTracks();
                        handleMusicBoxJumpscare();
                        return; 
                    }
                    
                    if (musicBoxTime > 0) {
                        musicBoxGraceTime = 0; 
                        fox = 0; 
                        musicBoxFinished = false; 
                        safeGetElement('creepyMusic').pause(); 
                    }

                } else if (musicBoxTime <= 0) {
                    if (!musicBoxFinished) { 
                        fox = 1; 
                        
                        musicBoxFinished = true; 
                        
                        let randomDelay = Math.floor(Math.random() * 7001) + 4000;
                        musicBoxGraceTime = randomDelay / 1000; 
                        
                        safePlay('creepyMusic', false); 
                        safePlay('dangerWarning'); 
                    }

                } else {
                    if (!isWinding) { 
                        musicBoxTime = Math.max(0, musicBoxTime - musicBoxDrainRate); 
                    }
                    fox = 0; 
                }

                if (musicBoxTime > 0 && tablet && currentCam === 5) { 
                    const activeTrack = safeGetElement(activeMusicBoxID);
                    if (activeTrack && activeTrack.paused) { 
                        playActiveMusicBoxTrack();
                    }
                } else {
                    stopAllMusicBoxTracks();
                }
                
                const dangerOverlay = safeGetElement('dangerOverlay');
                if (musicBoxGraceTime > 0) {
                    dangerOverlay.style.display = 'block';
                } else {
                    dangerOverlay.style.display = 'none';
                }

                updateMusicBoxUI();
                
                setTimeout(tickMusicBox, 50); 
            }

            function windUpMusicBox(isHolding) {
                const stopWinding = musicBoxJumpscareInProgress || powerCounter <= 0 || bearOutage === 1 || !tablet || currentCam !== 5 || musicBoxFinished;
                
                if (stopWinding) {
                    isWinding = false;
                    if (windupInterval) {
                        clearInterval(windupInterval);
                        windupInterval = null;
                    }
                    return;
                }
                
                isWinding = isHolding;
                
                if (isHolding) {
                    if (windupInterval === null) {
                        safePlay('windupEffect'); 
                        
                        windupInterval = setInterval(() => {
                            if (isWinding) { 
                                safePlay('windupEffect'); 
                                
                                musicBoxTime = Math.min(100, musicBoxTime + 1); 
                                
                                updateMusicBoxUI();
                            } else {
                                clearInterval(windupInterval);
                                windupInterval = null;
                            }
                        }, 200); 
                    }
                } else {
                    if (windupInterval) {
                        clearInterval(windupInterval);
                        windupInterval = null;
                    }
                }
                
                updateMusicBoxUI(); 
            }
            
            function handleMusicBoxJumpscare() {
                if (musicBoxJumpscareInProgress) return;

                musicBoxJumpscareInProgress = true;
                stopAllMusicBoxTracks();
                safePause('creepyMusic');
                gameOverCleanUp();
                
                safeGetElement('office').src = 'nightshift/foxy/jumpscare.gif'; 
                safePlay('specialJumpscare'); 
                
                setTimeout(function(){ window.location.href = 'game over_puppet.html' }, 1500); 
            }
            

            function updateUI() {
                updateOfficeImage(); 
                usage();

                const musicBoxUI = safeGetElement('musicBoxUI');
                if (musicBoxUI && !tablet) {
                    musicBoxUI.style.visibility = 'hidden';
                    stopAllMusicBoxTracks(); 
                }

                const leftBtn = safeGetElement('leftButtom');
                const rightBtn = safeGetElement('rightButtom');
                const monitorBtn = safeGetElement('monitor');
                const powerTxt = safeGetElement('powerTxt');

                const doorsVisible = !tablet && bearOutage === 0;

                if (leftBtn) {
                    leftBtn.src = leftDoor ? 'nightshift/leftOn.png' : 'nightshift/leftOff.png';
                    leftBtn.style.visibility = doorsVisible ? 'visible' : 'hidden';
                }
                if (rightBtn) {
                    rightBtn.src = rightDoor ? 'nightshift/rightOn.png' : 'nightshift/rightOff.png';
                    rightBtn.style.visibility = doorsVisible ? 'visible' : 'hidden';
                }
                if (monitorBtn) {
                    monitorBtn.style.visibility = bearOutage === 0 ? 'visible' : 'hidden';
                }

                const leftDoorIndicator = safeGetElement('leftDoor');
                const rightDoorIndicator = safeGetElement('rightDoor');

                if (leftDoorIndicator) {
                    leftDoorIndicator.style.visibility = (tablet && leftDoor) ? 'visible' : 'hidden';
                }
                if (rightDoorIndicator) {
                    rightDoorIndicator.style.visibility = (tablet && rightDoor) ? 'visible' : 'hidden';
                }
                
                if (powerTxt) {
                    powerTxt.innerText = `POWER LEFT: ${powerCounter}%`;
                }
            }

            function leftDoorToggle(){
                if (powerCounter <= 0 || bearOutage === 1 || tablet) return;
                
                leftDoor = !leftDoor;

                if (leftDoor) {
                    usageCounter++;
                } else {
                    usageCounter--;
                }
                
                safePlay('door');
                updateUI(); 
            }

            function rightDoorToggle(){
                if (powerCounter <= 0 || bearOutage === 1 || tablet) return;
                
                rightDoor = !rightDoor;

                if (rightDoor) {
                    usageCounter++;
                } else {
                    usageCounter--;
                }
                
                safePlay('door');
                updateUI(); 
            }
            
            function handleMonitorClick(){
                if(powerCounter <= 0 || bearOutage === 1) return;

                tablet = !tablet;

                const visible = tablet ? 'visible' : 'hidden';
                const camButtons = ['showStage', 'diningArea', 'backstage', 'pirateCove', 'restrooms', 'kitchen', 'westHall', 'supplyCloset', 'westCorner', 'eastHall', 'eastCorner'];

                safeGetElement('camera').style.visibility = visible;
                safeGetElement('static').style.visibility = visible;
                safeGetElement('map').style.visibility = visible;
                
                if (safeGetElement('goldenOffice')) {
                    safeGetElement('goldenOffice').style.visibility = 'hidden';
                    goldenScare = 0;
                }
                
                const musicBoxUI = safeGetElement('musicBoxUI');
                if (musicBoxUI && !tablet) { 
                    musicBoxUI.style.visibility = 'hidden';
                }
                stopAllMusicBoxTracks();
                
                if (musicBoxGraceTime <= 0) {
                    safePause('creepyMusic');
                }
                
                if (!tablet) {
                    windUpMusicBox(false);
                }

                camButtons.forEach(id => {
                    const el = safeGetElement(id);
                    if (el) el.style.visibility = visible;
                });
                
                if (tablet) {
                    safePlay('tabletOn');
                    safePlay('ambienceCamera', false);
                    usageCounter++;
                    camera(currentCam); 
                } else {
                    safePause('ambienceCamera');
                    safePlay('tabletOff');
                    usageCounter--;
                    windUpMusicBox(false); 
                    goldenJumpscare(); 
                    goldenAI();
                }
                
                updateUI(); 
            }

            function camera(camCounter, noBlip = false){
                if (!tablet) return;

                currentCam = camCounter;

                const camImg = safeGetElement('camera');
                const musicBoxUI = safeGetElement('musicBoxUI');
                if (!camImg || !musicBoxUI) return;

                if (!noBlip) {
                    safePlay('blip');
                }
                goldenAI(); 
                
                stopAllMusicBoxTracks();
                
                if (musicBoxGraceTime <= 0) {
                    safePause('creepyMusic'); 
                }

                if (camCounter === 5) { 
                    musicBoxUI.style.visibility = 'visible';
                    if (musicBoxTime > 0) {
                        playActiveMusicBoxTrack();
                    }
                    else if (musicBoxGraceTime > 0) { 
                        safePlay('creepyMusic', false);
                    }
                } else {
                    musicBoxUI.style.visibility = 'hidden'; 
                    windUpMusicBox(false); 
                }

                var basePath = 'nightshift/';
                var imgName = '';
                var playKitchen = false;
                
                if (camCounter === 0) imgName = 'showStage.png';
                else if (camCounter === 1) imgName = 'diningArea.png';
                else if (camCounter === 2) imgName = 'backstage.png';
                else if (camCounter === 3) imgName = 'pirateCove.png';
                else if (camCounter === 4) imgName = 'restrooms.png';
                else if (camCounter === 5) { imgName = 'cam6.png'; playKitchen = true; } 
                else if (camCounter === 6) imgName = 'westHall.png';
                else if (camCounter === 7) imgName = 'supplyCloset.png';
                else if (camCounter === 8) imgName = 'westCorner.png';
                else if (camCounter === 9) imgName = 'eastHall.png';
                else if (camCounter === 10) imgName = 'eastCorner.png';
                
                camImg.src = basePath + imgName;
                
                if (playKitchen) { safePlay('kitchen1'); safePlay('kitchen2'); }

                if (camCounter === 0 && bunny >= 1) camImg.src = 'nightshift/bonnie/showStage.png';
                else if (camCounter === 1 && bunny === 1) camImg.src = 'nightshift/bonnie/diningArea.png';
                else if (camCounter === 2 && bunny === 2) camImg.src = 'nightshift/bonnie/backstage.png';
                else if (camCounter === 6 && bunny === 3) camImg.src = 'nightshift/bonnie/westHall.png';
                else if (camCounter === 7 && bunny === 4) camImg.src = 'nightshift/bonnie/supplyCloset.png';
                else if (camCounter === 8 && bunny === 5) camImg.src = 'nightshift/bonnie/westCorner.png';
                
                if (camCounter === 0) {
                    if (bunny >= 1 && chicken >= 1) camImg.src = 'nightshift/chica/showStageA.png'; 
                    else if (camCounter === 0 && bunny <= 0 && chicken >= 1) camImg.src = 'nightshift/chica/showStageB.png';
                }
                else if (camCounter === 1 && chicken === 1) camImg.src = 'nightshift/chica/diningArea.png';
                else if (camCounter === 4 && chicken === 2) camImg.src = 'nightshift/chica/restrooms.png';
                else if (camCounter === 5 && chicken === 3) camImg.src = 'nightshift/chica/kitchen.png';
                else if (camCounter === 9 && chicken === 4) camImg.src = 'nightshift/chica/eastHall.png';
                else if (camCounter === 10 && chicken === 5) camImg.src = 'nightshift/chica/eastCorner.png';

                if (camCounter === 0 && bear >= 1) camImg.src = 'nightshift/freddy/showStage.png';
                else if (camCounter === 1 && bear === 1) camImg.src = 'nightshift/freddy/diningArea.png';
                else if (camCounter === 4 && bear === 2) camImg.src = 'nightshift/freddy/restrooms.png';
                else if (camCounter === 5 && bear === 3) camImg.src = 'nightshift/freddy/kitchen.png';
                else if (camCounter === 9 && bear === 4) camImg.src = 'nightshift/freddy/eastHall.png';
                else if (camCounter === 10 && bear === 5) camImg.src = 'nightshift/freddy/eastCorner.png';
                
                if (camCounter === 3) { 
                    camImg.src = 'nightshift/foxy/pirateCove1.png'; 
                }
                
                if (camCounter === 8 && goldenRandom === 4) camImg.src = 'nightshift/goldenFreddy/westCorner.png';
            }
            
            function staticEffect(){
                const st = safeGetElement('static');
                if (!st) return;

                st.style.opacity = 1;
                setTimeout(function(){ 
                    if (st) st.style.opacity = 0.3; 
                }, 500);
            }

            function timer(){
                const timerTxt = safeGetElement('timerTxt');
                if (!timerTxt) return;

                timerTxt.innerText = timerCounter + (timerCounter === 12 ? ':00 AM' : ' AM');
                
                timerCounter++;
                if (timerCounter > 12) timerCounter = 1;
                
                if (timerCounter === 7) { 
                     window.location.href = 'survived.html';
                     return;
                }

                const delay = (timerCounter === 1 || timerCounter === 12) ? 30000 : 29000;
                
                setTimeout(timer, delay);
            }

            function power(){
                const powerTxt = safeGetElement('powerTxt');
                if (!powerTxt) return;

                powerTxt.innerText = `POWER LEFT: ${powerCounter}%`;
                
                if (powerCounter <= 0) {
                    powerCounter = 0; 
                    powerDown();
                    return;
                }
                
                powerCounter--;

                let drainSpeed = 4000; 
                if (usageCounter === 2) drainSpeed = 2000; 
                else if (usageCounter === 3) drainSpeed = 1500; 
                else if (usageCounter >= 4) drainSpeed = 1100; 

                setTimeout(power, drainSpeed);
            }

            function powerDown(){
                if (bearOutage === 0) {
                    bearOutage = 1;
                    
                    if(tablet) handleMonitorClick(); 
                    
                    gameOverCleanUp(); 

                    safeGetElement('timerTxt').style.visibility = 'hidden';
                    safeGetElement('powerTxt').style.visibility = 'hidden';
                    safeGetElement('usageTxt').style.visibility = 'hidden';

                    safeGetElement('office').src = 'nightshift/434.png'; 
                    
                    safePlay('powerDown');
                    
                    setTimeout(function(){ 
                        safePlay('musicBox1'); 
                    }, 5000); 

                    const randomDelay = Math.floor(Math.random() * 7001) + 13000; 
                    
                    setTimeout(function(){
                          stopAllMusicBoxTracks();

                          gameOverCleanUp(); 
                          safeGetElement('office').src = 'nightshift/powerDown/jumpscare.gif';
                          safePlay('jumpscare');
                          setTimeout(function(){ window.location.href = 'game over.html' }, 1900);
                    }, randomDelay); 

                } 
            }

            function bonnie(){
                if (powerCounter <= 0 || bearOutage === 1) return;

                if (bunny === -1) bunny = 0;
                else if (bunny === 0) bunny = 1;
                else if (bunny === 1) bunny = Math.floor(Math.random() * 2) + 2;
                else if (bunny === 2) bunny = 1;
                else if (bunny === 3) bunny = Math.floor(Math.random() * 2) + 4;
                else if (bunny === 4) bunny = 3;
                else if (bunny === 5) bunny = 6;

                if (bunny === 6){
                    if (leftDoor === true){
                        bunny = (bear <= 0) ? -1 : 0;
                        setTimeout(bonnie, 5000);
                        return;
                    } else {
                        bunny = 7;
                        setTimeout(bonnie, 5000);
                        return;
                    }
                }
                
                if (bunny === 7){
                    if (leftDoor === true) {
                        bunny = (bear <= 0) ? -1 : 0;
                        setTimeout(bonnie, 5000);
                        return;
                    } else {
                        gameOverCleanUp(); 
                        safeGetElement('office').src = 'nightshift/bonnie/jumpscare.gif';
                        safePlay('jumpscare');
                        setTimeout(function(){window.location.href = 'game over.html'}, 1100);
                        return;
                    }
                }
                
                if (bunny === 0) safePlay('walk1');
                else if (bunny === 1) safePlay('walk2');
                else if (bunny === 2) safePlay('walk3');
                else if (bunny === 3) safePlay('walk4');
                else if (bunny === 4) safePlay('walk5');
                else if (bunny === 5) safePlay('walk1');

                if (bunny < 6) {
                    if (tablet) {
                        staticEffect();
                        if (currentCam === 0 || currentCam === 1 || currentCam === 2 || currentCam === 6 || currentCam === 7 || currentCam === 8) {
                            camera(currentCam, true);
                        }
                    }
                    setTimeout(bonnie, 5000);
                }
            }

            function chica(){
                if (powerCounter <= 0 || bearOutage === 1) return;
                
                if (chicken === -1) chicken = 0;
                else if (chicken === 0) chicken = 1;
                else if (chicken === 1) chicken = Math.floor(Math.random() * 3) + 2;
                else if (chicken === 2) chicken = 1;
                else if (chicken === 3) chicken = 1;
                else if (chicken === 4) chicken = 5;
                else if (chicken === 5) chicken = 6;

                if (chicken === 6){
                    if (rightDoor === true){
                        chicken = (bear <= 0) ? -1 : 0;
                        setTimeout(chica, 10000);
                        return;
                    } else {
                        chicken = 7;
                        setTimeout(chica, 5000);
                        return;
                    }
                }

                if (chicken === 7){
                    if (rightDoor === true) {
                        chicken = (bear <= 0) ? -1 : 0;
                        setTimeout(chica, 10000);
                        return;
                    } else {
                        gameOverCleanUp(); 
                        safeGetElement('office').src = 'nightshift/chica/jumpscare.gif';
                        safePlay('oui');
                        setTimeout(function(){window.location.href = 'game over.html'}, 1100);
                        return;
                    }
                }

                if (chicken < 6) {
                    if (tablet) {
                        staticEffect();
                        if (currentCam === 0 || currentCam === 1 || currentCam === 4 || currentCam === 5 || currentCam === 9 || currentCam === 10) {
                            camera(currentCam, true);
                        }
                    }
                    setTimeout(chica, 6000);
                }
            }

            function freddy(){
                if (powerCounter <= 0 || bearOutage === 1) return;
                
                if (bear === -1) bear = 0;
                else if (bear === 0) bear = 1;
                else if (bear === 1) bear = Math.floor(Math.random() * 3) + 2;
                else if (bear === 2) bear = 1;
                else if (bear === 3) bear = 1;
                else if (bear === 4) bear = 5;
                else if (bear === 5) bear = 6;

                if (bear === 6){
                    if (rightDoor === true){
                        bear = -1;
                        setTimeout(freddy, 12000);
                        return;
                    } else {
                        bear = 7;
                        setTimeout(freddy, 5000);
                        return;
                    }
                }

                if (bear === 7){
                    if (rightDoor === true) {
                        bear = -1; 
                        setTimeout(freddy, 12000);
                        return;
                    } else {
                        gameOverCleanUp(); 
                        safeGetElement('office').src = 'nightshift/freddy/jumpscare.gif';
                        safePlay('jumpscare');
                        setTimeout(function(){window.location.href = 'game over.html'}, 1200);
                        return;
                    }
                }

                if (bear < 6) {
                    if (tablet) {
                        staticEffect();
                        if (currentCam === 0 || currentCam === 1 || currentCam === 4 || currentCam === 5 || currentCam === 9 || currentCam === 10) {
                            camera(currentCam, true);
                        }
                    }
                    setTimeout(freddy, 12000);
                }
            }

            function goldenAI(){
                if (powerCounter <= 0 || bearOutage === 1 || tablet) return;
                
                goldenRandom = Math.floor(Math.random() * 10);

                if (goldenRandom === 4) {
                    if (goldenScare === 0) {
                        safeGetElement('goldenOffice').style.visibility = 'visible';
                        safePlay('goldenLaugh');
                        goldenScare = 1;
                    }
                } else if (goldenRandom !== 4) {
                    if (goldenScare === 1) {
                        safeGetElement('goldenOffice').style.visibility = 'hidden';
                        goldenScare = 0;
                    }
                }
            }
            
            function goldenJumpscare(){
                if (goldenScare === 1 && !tablet) {
                    gameOverCleanUp();
                    safeGetElement('office').src = 'nightshift/goldenFreddy/jumpscare.gif';
                    safePlay('goldenJumpscare');
                    setTimeout(function(){ window.location.href = 'game over.html' }, 2700);
                }
            }

            function unlockAudioContext() {
                if (audioContextUnlocked) return;
                
                const audio = safeGetElement('audio');
                if (audio) {
                    audio.play().then(() => {
                        audioContextUnlocked = true;
                        document.removeEventListener('click', unlockAudioContext);
                        document.removeEventListener('touchstart', unlockAudioContext);
                    }).catch(e => {
                        console.info('Audio context still locked. Try clicking/touching again.', e);
                    });
                }
            }

            function initialStart() {
                setupMusicBoxListeners(); 
                selectNextMusicBoxTrack(); 

                const audio = safeGetElement('audio');
                if (audio) {
                    audio.volume = 0.5;
                }
                
                const nightScreen = safeGetElement('nightScreen'); 
                const warningOverlay = safeGetElement('warningOverlay');

                document.addEventListener('click', unlockAudioContext);
                document.addEventListener('touchstart', unlockAudioContext);

                setTimeout(() => {
                    if (nightScreen) {
                        nightScreen.style.display = 'none'; 
                    }

                    updateUI();
                    timer();
                    power();
                    bonnie();
                    chica();
                    freddy(); 
                    tickMusicBox(); 

                    if (warningOverlay) {
                         warningOverlay.style.visibility = 'visible';
                    }

                    setTimeout(() => {
                        if (warningOverlay) {
                             warningOverlay.style.visibility = 'hidden';
                        }
                    }, 6000); 

                }, 4000); 
            }

            window.onload = initialStart;
        </script>
    </body>
</html>
